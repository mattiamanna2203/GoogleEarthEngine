/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var rome = 
    /* color: #cfd5d6 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[12.456862923570267, 41.800206838817076],
          [12.510592934556595, 41.7938080682038],
          [12.526448928695663, 41.79520300796906],
          [12.54999216245479, 41.8002562723041],
          [12.553888144584139, 41.8014551533948],
          [12.573200049491366, 41.81239535767635],
          [12.574906210183293, 41.813439206267965],
          [12.592158178567082, 41.83991784798773],
          [12.596020559548528, 41.84728036789285],
          [12.600741247414739, 41.862815290792014],
          [12.615346502448723, 41.88972077251749],
          [12.616120098859852, 41.91470385518307],
          [12.614575146467274, 41.917003135930614],
          [12.59071421507079, 41.9473418757509],
          [12.583190994655391, 41.95631725834453],
          [12.578041153346797, 41.960019198021726],
          [12.569372253810664, 41.963848564490455],
          [12.510099932518202, 41.990575150334124],
          [12.506752535667616, 41.99124153103335],
          [12.501688525047499, 41.99105015051401],
          [12.494993731346327, 41.9866482397576],
          [12.488728091087538, 41.98594645773824],
          [12.481260821190077, 41.9867120377394],
          [12.472619071264663, 41.98598307055443],
          [12.46446515585939, 41.983941480049964],
          [12.45897199179689, 41.98196362681877],
          [12.454165473242202, 41.981580809419484],
          [12.445582404394546, 41.98241024420899],
          [12.443824031289784, 41.98233645480763],
          [12.427902438577382, 41.97895484128696],
          [12.420907237466542, 41.97416923226558],
          [12.413631640531824, 41.971424890848546],
          [12.40697976217489, 41.970340056070214],
          [12.404018603422449, 41.96919138734364],
          [12.385337527893476, 41.95743865876028],
          [12.383296933874156, 41.95459828164387],
          [12.3822240502682, 41.94642750240788],
          [12.38050517180108, 41.93190008568986],
          [12.381224081574391, 41.92365438016756],
          [12.38312927585329, 41.91952891147853],
          [12.385060466344013, 41.912567221560145],
          [12.382828868443623, 41.900776008864746],
          [12.381541408116474, 41.89694285405644],
          [12.38115517001833, 41.89529565741875],
          [12.380554355198994, 41.88424182123252],
          [12.380425609166279, 41.880977059684774],
          [12.375018275792256, 41.86992074593529],
          [12.373333494587827, 41.866188816590146],
          [12.373161833210874, 41.865006311792925],
          [12.376122991963316, 41.85752726139448],
          [12.382789178860602, 41.84145819021349],
          [12.386994882595953, 41.82798852051592],
          [12.390141274556168, 41.81905663542348],
          [12.391428734883316, 41.81665787723656],
          [12.394092940375616, 41.814145319917216],
          [12.39851322083216, 41.81152247192572],
          [12.40649547486048, 41.80941132114158],
          [12.420931756949667, 41.80708810777483],
          [12.43110269353414, 41.80398511707169],
          [12.433858189870763, 41.803204362113114],
          [12.459264073659826, 41.800005206318296],
          [12.49784496813004, 41.79536614671478],
          [12.510521056428065, 41.79377050430897]]]),
    S2_SR_coll = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED"),
    ESA_world_LCs = ee.ImageCollection("ESA/WorldCover/v200"),
    csPlus = ee.ImageCollection("GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED"),
    paris = /* color: #acd3d6 */ee.Geometry.Polygon(
        [[[2.322569891237185, 48.90066721945779],
          [2.3217115843524194, 48.9005261637169],
          [2.313612089946173, 48.89810659157636],
          [2.3111873729967103, 48.89721788823638],
          [2.306230650737189, 48.89521472117879],
          [2.3033124073289857, 48.89343481526482],
          [2.296982394053839, 48.889780814587766],
          [2.2956949337266908, 48.8893434452607],
          [2.293313132121466, 48.88882141879761],
          [2.2918031724367793, 48.88825472645813],
          [2.2841023342155164, 48.88358418065205],
          [2.282214059069032, 48.88187679617024],
          [2.280990971758241, 48.880155242059615],
          [2.280781679932451, 48.879476254092765],
          [2.2787432010811326, 48.876936113533496],
          [2.277005129639482, 48.875891796109755],
          [2.2761253650825974, 48.87512971287901],
          [2.2745847613826653, 48.8733273003732],
          [2.2721600444332024, 48.87058925138507],
          [2.2697711739456583, 48.868370461873134],
          [2.268054560176127, 48.8659144496034],
          [2.2661706354466693, 48.86403244698742],
          [2.2641750719395892, 48.86255025655993],
          [2.2630861544248315, 48.86020456771772],
          [2.262270762884304, 48.85927283902975],
          [2.260725810491726, 48.85855285498263],
          [2.258068553345325, 48.857058108648395],
          [2.252425185577991, 48.85310495250623],
          [2.2517170823980592, 48.85137368762676],
          [2.2523393548895143, 48.84871915869301],
          [2.2542276300359987, 48.84685525640955],
          [2.2546475639901287, 48.84509829491744],
          [2.2534244766793377, 48.8403392142699],
          [2.2540013225275857, 48.83812400235842],
          [2.2559539706904275, 48.83634444798048],
          [2.2579280765253884, 48.835200415354045],
          [2.265930820003206, 48.83456483038351],
          [2.2729045634419265, 48.83486143770659],
          [2.274513888850862, 48.83453658197544],
          [2.283862230488416, 48.83084533637098],
          [2.2918659421888554, 48.827370404704794],
          [2.297617389488633, 48.82590383518639],
          [2.3143106869623287, 48.82230300260962],
          [2.332635903922089, 48.818194475597394],
          [2.3346743827734073, 48.81703589939277],
          [2.335532689658173, 48.81671092808762],
          [2.3458752876195987, 48.81603896469872],
          [2.347291493979462, 48.816335681690475],
          [2.349244142142304, 48.81718343484681],
          [2.3510251289281925, 48.81770620881342],
          [2.352312589255341, 48.8178333692242],
          [2.3534498458776554, 48.8177203377639],
          [2.3542572000729534, 48.817382143028624],
          [2.3554802873837444, 48.81642135884345],
          [2.3564029672848674, 48.81605399531791],
          [2.360909078429887, 48.81561598144203],
          [2.3635912874447795, 48.815842053597805],
          [2.364806466871623, 48.816251806781565],
          [2.3786037500442303, 48.82118271172405],
          [2.379805379682902, 48.82183259424734],
          [2.3845689828933514, 48.82471458041037],
          [2.386706357619639, 48.82562010011493],
          [2.3917766387620576, 48.827293396666946],
          [2.3954459006944306, 48.82780900213927],
          [2.400139802723853, 48.8289154970065],
          [2.4010975567870307, 48.82936505939253],
          [2.403323466782674, 48.83080585660764],
          [2.407346780305013, 48.8331011587489],
          [2.410866432876846, 48.834267994662284],
          [2.412118216096726, 48.83512105235705],
          [2.413954031564649, 48.840817440888856],
          [2.4141686082858405, 48.84361360539014],
          [2.415222369020511, 48.84830791902536],
          [2.4155656917744173, 48.851301338448366],
          [2.4150077922993196, 48.852459122492945],
          [2.414321146791507, 48.85420986702261],
          [2.414278231447269, 48.85635585744174],
          [2.414468641049754, 48.85873333596684],
          [2.4141175399612713, 48.8612398150836],
          [2.4139887939285565, 48.864472916023914],
          [2.4138922344040203, 48.86743713910008],
          [2.4135596404861737, 48.868235728997284],
          [2.413581098158293, 48.87029643344379],
          [2.413552442560838, 48.87067992534213],
          [2.4131876621348125, 48.87184431804651],
          [2.412743388499452, 48.87262345314506],
          [2.410624319682353, 48.87512492126316],
          [2.4092723970038277, 48.8773195837658],
          [2.4082799796683174, 48.878872871209275],
          [2.407743537865339, 48.879479670796854],
          [2.407019341431318, 48.88003001754517],
          [2.406321967087446, 48.8804004398316],
          [2.4055972308040996, 48.880678079103134],
          [2.403419277084007, 48.881302495567056],
          [2.402203183244218, 48.88184947351945],
          [2.4017210540128398, 48.88227391105538],
          [2.4004335936856913, 48.883289874330984],
          [2.39796596139199, 48.885476947455246],
          [2.397644096310203, 48.88597078943958],
          [2.39721494286782, 48.887756262106095],
          [2.395423619990309, 48.893457603542146],
          [2.394667283574652, 48.89616837759049],
          [2.394298266784527, 48.89765874293738],
          [2.394101364422032, 48.89814222632862],
          [2.393775278352286, 48.89870165708692],
          [2.3929598868117585, 48.899449275267],
          [2.391479307435538, 48.900210987949826],
          [2.389698320649649, 48.900577734360745],
          [2.387644479768203, 48.90068310253761],
          [2.376851270692275, 48.90041509637472],
          [2.3720815539746454, 48.900852368847396],
          [2.359001445746869, 48.90102163458395],
          [2.3534868240122497, 48.90131784824355],
          [2.350923967509031, 48.90143147321661],
          [2.323028993754148, 48.90081083446934]]]),
    milan = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[9.143067728627331, 45.47527078780532],
          [9.145771395314343, 45.4667839310802],
          [9.146500956166394, 45.46503824890694],
          [9.155190338638715, 45.450167661414966],
          [9.157078613785199, 45.448963393633406],
          [9.157979836014203, 45.44697629558048],
          [9.162473233104093, 45.4446278167226],
          [9.180583508372647, 45.44336321068693],
          [9.188909085154874, 45.445832177068155],
          [9.210452587962491, 45.446821254625135],
          [9.21697572028671, 45.45555194508049],
          [9.21776672930072, 45.45822984012514],
          [9.217595067923767, 45.4711421491396],
          [9.217209378339657, 45.48594626135981],
          [9.200492902038944, 45.49407709196834],
          [9.187302078920991, 45.49777189441985],
          [9.17112299414316, 45.496869458608515],
          [9.165396076064715, 45.49874821841926],
          [9.163379054885516, 45.497966121779235],
          [9.146949828656412, 45.487309679493535],
          [9.143473685773111, 45.484872616937174],
          [9.142915786298014, 45.48330802738101],
          [9.142486632855631, 45.47713951061913]]]),
    milan2 = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[9.217483634315226, 45.38901985140333],
          [9.24035751279423, 45.38359457189982],
          [9.257688674105834, 45.382299407913194],
          [9.26554218210144, 45.38199798132393],
          [9.269189986361694, 45.38437920757868],
          [9.267945441378783, 45.385601689985144],
          [9.26155105508728, 45.39205145702982],
          [9.260606917514037, 45.39566782677577],
          [9.261679801119994, 45.40231845424319],
          [9.261679801119994, 45.4072297410219],
          [9.259519060511838, 45.40952022392887],
          [9.246644457240354, 45.419582100347036],
          [9.24607721820645, 45.426021434263966],
          [9.24830881610684, 45.42852127742198],
          [9.25431876607309, 45.432777057993306],
          [9.256355402225095, 45.435725728884734],
          [9.259316560977537, 45.44677651435833],
          [9.259203422570813, 45.4485474023321],
          [9.257873046899427, 45.451166671219276],
          [9.252524499611642, 45.45791111197851],
          [9.252438668923165, 45.4677837821225],
          [9.252910737709787, 45.472297476004016],
          [9.25406945200422, 45.476721202474494],
          [9.25141907957018, 45.48389927413562],
          [9.252491963176137, 45.49050491134286],
          [9.25566769864977, 45.49637114855434],
          [9.25648983759837, 45.50119025694629],
          [9.262395599198605, 45.50955850336649],
          [9.262052276444699, 45.511753910397395],
          [9.26252434523132, 45.51452060277],
          [9.261623123002316, 45.52052284234906],
          [9.259434440446164, 45.52849050916162],
          [9.259892827401517, 45.52940333269614],
          [9.26281107080972, 45.53129733596403],
          [9.263454800973294, 45.53301090301117],
          [9.261734073807979, 45.537167966448365],
          [9.259802883317256, 45.539602765602005],
          [9.259197664601873, 45.5445799343239],
          [9.262330484731267, 45.550170060661905],
          [9.264132929189275, 45.55056074763127],
          [9.266407442433904, 45.552093416440094],
          [9.267330222579998, 45.55298001127925],
          [9.26728730723576, 45.55460276592079],
          [9.265871100875897, 45.55664616807411],
          [9.262352042648358, 45.55742744926103],
          [9.259127472216568, 45.5583855080309],
          [9.255865906054458, 45.56024848756774],
          [9.250372741991958, 45.560969624353596],
          [9.241618011767349, 45.56084943553207],
          [9.2348373873777, 45.56451507892461],
          [9.231232498461685, 45.566317766626945],
          [9.227799270922622, 45.56902168971495],
          [9.224823277434941, 45.573630345380394],
          [9.2198450975033, 45.57669438275861],
          [9.214952748260137, 45.576994769581425],
          [9.205082219085332, 45.57669438275861],
          [9.202838876753594, 45.57579321264878],
          [9.198289850264336, 45.56990521203801],
          [9.195629098921563, 45.56762194367217],
          [9.178569909216874, 45.5626132749546],
          [9.166725274207108, 45.55876721765655],
          [9.159693506192523, 45.558559101330786],
          [9.154972818326312, 45.5594605479703],
          [9.148106363248187, 45.55831871311774],
          [9.14553144259389, 45.55645566959685],
          [9.144587305020648, 45.554772867518075],
          [9.147848871182758, 45.54689908838542],
          [9.147505548428851, 45.54491544337376],
          [9.146218088101703, 45.543773312977955],
          [9.144501474332172, 45.542871614695954],
          [9.133343484830219, 45.54221036009757],
          [9.123751470735373, 45.536376172025456],
          [9.11731416909963, 45.535113624291135],
          [9.11456758706838, 45.533790924833035],
          [9.111563512971701, 45.53108530631618],
          [9.109388809276776, 45.53049968714958],
          [9.10106323249455, 45.530259178922506],
          [9.099089126659589, 45.53074019434822],
          [9.094540100170331, 45.53013892442329],
          [9.09230850226994, 45.52779391029902],
          [9.091793518139081, 45.52388533616724],
          [9.088446121288495, 45.52093869306359],
          [9.085957031322675, 45.515826803250285],
          [9.082523803783612, 45.51546594642147],
          [9.080206375194745, 45.51630794208912],
          [9.07582901008244, 45.516608651774376],
          [9.06012199409123, 45.52496773773161],
          [9.058405380321698, 45.52081841863832],
          [9.05879225460095, 45.51827862661495],
          [9.065754257041059, 45.501343834567535],
          [9.065754257041059, 45.49075501538129],
          [9.066612563925824, 45.4874632034404],
          [9.077083907919965, 45.47602918869375],
          [9.078628860312543, 45.47181607200219],
          [9.074852310019574, 45.464592853456566],
          [9.076929975731408, 45.456815727439185],
          [9.07315342543844, 45.44308716876248],
          [9.07538502333883, 45.42778913781283],
          [9.08423295504913, 45.41681465838754],
          [9.104145674775692, 45.41078950275371],
          [9.12543168551788, 45.39909886763443],
          [9.136771706935013, 45.39632650653206],
          [9.166640786524857, 45.38595908159311],
          [9.173850564356888, 45.38571795606012],
          [9.192389993067826, 45.3907813762635],
          [9.203547982569779, 45.3907813762635]]]),
    paris2 = 
    /* color: #ffffd1 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[2.43166705033123, 48.91483801759623],
          [2.4305512513810346, 48.91593792673858],
          [2.4290062989884564, 48.9188144976917],
          [2.427590092628593, 48.92310084508853],
          [2.4270466625413034, 48.923812453351246],
          [2.424857979985151, 48.925560701358904],
          [2.419064408512983, 48.9277882190168],
          [2.4166055336778403, 48.92856441936782],
          [2.414760173875594, 48.92873359123437],
          [2.4031730309312582, 48.92670349100663],
          [2.388126971622153, 48.924499737420426],
          [2.3814750932652196, 48.92308983481788],
          [2.3759390138584813, 48.92159529460107],
          [2.3714758180577, 48.92114410386003],
          [2.3687721513706883, 48.921623493887054],
          [2.3594622547196886, 48.92233846909957],
          [2.3495058948564074, 48.9229306419498],
          [2.3445277149247667, 48.92321262655346],
          [2.3398928577470324, 48.92569402241198],
          [2.337275021748497, 48.9266245140717],
          [2.3333697254228136, 48.927639576107985],
          [2.3309235508012316, 48.9288801794642],
          [2.325100868936527, 48.93047091437862],
          [2.3244142234287146, 48.9309220208574],
          [2.3227405250034217, 48.932106155972455],
          [2.3208951652011756, 48.934728069498],
          [2.3192214667758826, 48.93656050795089],
          [2.3173668721766694, 48.93754717771831],
          [2.3135903218837006, 48.938421068939874],
          [2.3050501683802826, 48.939351323428255],
          [2.3010590413661225, 48.93884391403841],
          [2.2899268769033165, 48.936671358602496],
          [2.275078167796871, 48.933767623729864],
          [2.273444585998119, 48.93390715020967],
          [2.265376501281322, 48.93573961879603],
          [2.2617716123653064, 48.93602153106981],
          [2.2588533689571033, 48.935091214524405],
          [2.2500557233882557, 48.93306137279042],
          [2.2440827101965244, 48.931144600946524],
          [2.226277983430709, 48.92230491292953],
          [2.2237459781206503, 48.919682347001114],
          [2.2157146504033376, 48.9108158936874],
          [2.212710576306658, 48.907854241050146],
          [2.2032651600079545, 48.902356219308885],
          [2.196184128208638, 48.897024215610436],
          [2.1886310276227006, 48.89366673628121],
          [2.184296577854634, 48.8926509838214],
          [2.1817216572003373, 48.89256633685153],
          [2.1775348242697845, 48.89188435331129],
          [2.1689946707663665, 48.88993740689179],
          [2.1657760199484954, 48.88728492310779],
          [2.164960628407968, 48.88587397015043],
          [2.1655185278830658, 48.88276973350847],
          [2.1636100776897482, 48.87950576953603],
          [2.157773590873342, 48.87476407228187],
          [2.1557136543499045, 48.87216723808132],
          [2.157945252250295, 48.86934443932627],
          [2.159146881888967, 48.866521481313974],
          [2.1596618660198263, 48.86347250778057],
          [2.159146881888967, 48.86087508750926],
          [2.1553703315959982, 48.855792788403974],
          [2.1500383633860443, 48.85011075098788],
          [2.1435152310618255, 48.84028239418468],
          [2.1438585538157318, 48.836779869903744],
          [2.146948458600888, 48.83248611893349],
          [2.1481604966020917, 48.82755255208056],
          [2.1515937241411542, 48.82291895183043],
          [2.1574302109575605, 48.81579819454631],
          [2.162924628527678, 48.80555151041369],
          [2.164083342822112, 48.801622555413616],
          [2.163525443347014, 48.79746713862573],
          [2.1623238137083423, 48.79427260461839],
          [2.160625756829595, 48.791457639015746],
          [2.1568492065366263, 48.78758412976615],
          [2.155733407586431, 48.78455862624695],
          [2.1630294952415907, 48.78168033018503],
          [2.168737236025282, 48.78111476284087],
          [2.1935484608139832, 48.77929412584819],
          [2.2215753514004444, 48.77726992783425],
          [2.2244935948086475, 48.77690227748315],
          [2.228964386545469, 48.776033391884134],
          [2.234757958017637, 48.77608995463087],
          [2.2369466405737892, 48.77583542176869],
          [2.2396073919165627, 48.77481727741448],
          [2.2416591357977156, 48.773290022166485],
          [2.243247003534532, 48.771027336398674],
          [2.243890733698106, 48.76768968876094],
          [2.245262199825171, 48.765017333951285],
          [2.2485237659872803, 48.76224507314641],
          [2.251699501460913, 48.76091546520115],
          [2.2558622898520264, 48.76006676087512],
          [2.2635441364706788, 48.75964240333442],
          [2.2775774540365967, 48.75975556569581],
          [2.2845796741439406, 48.7604911148307],
          [2.2864250339461867, 48.760462824678505],
          [2.290459076304585, 48.76006676087512],
          [2.294278541941792, 48.7605759851916],
          [2.300330448184975, 48.76176471069105],
          [2.305661456416672, 48.7630637121666],
          [2.3081242656810375, 48.763305217388606],
          [2.3087250805003734, 48.763305217388606],
          [2.3130569743308182, 48.76240029694259],
          [2.3200332449916505, 48.760148003825314],
          [2.3228856035482393, 48.759261839463335],
          [2.3319044110849063, 48.75644148760427],
          [2.333535194165961, 48.756073684732854],
          [2.335981368787543, 48.75576246481528],
          [2.339184505168239, 48.755706096606175],
          [2.3450424496567646, 48.75480071759463],
          [2.354093233072976, 48.753593171873085],
          [2.3589426669719016, 48.75339511327888],
          [2.367416615800897, 48.75346153543467],
          [2.369712586717645, 48.75354641767273],
          [2.372459168748895, 48.75346153543467],
          [2.3776948407459653, 48.75319274073475],
          [2.3795831158924496, 48.753447388381026],
          [2.381943459825555, 48.754395232165706],
          [2.3839051687280755, 48.75610198001973],
          [2.384312864498339, 48.757601466299214],
          [2.384119745449267, 48.758846288829844],
          [2.3836047613184075, 48.75972330436229],
          [2.3814608143951332, 48.76292214673748],
          [2.3788644360687172, 48.767108710925584],
          [2.3787786053802407, 48.767632006909615],
          [2.3789288090850746, 48.76824324110161],
          [2.3794008778716957, 48.768922095178134],
          [2.380366473117057, 48.7696009400771],
          [2.381696848788444, 48.76998278629968],
          [2.39302649966735, 48.77139700627472],
          [2.396768989854743, 48.77208830390536],
          [2.401987832099781, 48.77348017676748],
          [2.4047987871473886, 48.77389027609358],
          [2.4071945569656394, 48.773941905465094],
          [2.409748019947817, 48.774111600583595],
          [2.4146832845352195, 48.77604891253181],
          [2.415841998829653, 48.77638828795133],
          [2.4174823432021464, 48.77656771930084],
          [2.4264731078200663, 48.77597381293385],
          [2.4371723326084815, 48.776287500242795],
          [2.4394253881809913, 48.77702280725729],
          [2.4402193220493995, 48.77756014018749],
          [2.441506782376548, 48.77896000686234],
          [2.441656986081382, 48.780586065603714],
          [2.440773407317187, 48.78382137337143],
          [2.440430084563281, 48.78696002239727],
          [2.440422842036143, 48.788100740222205],
          [2.441066572199717, 48.79142289461272],
          [2.441538640986338, 48.7926386067754],
          [2.44258478405607, 48.793873752891635],
          [2.4431212258590485, 48.795301435112414],
          [2.44458034756315, 48.797421680265806],
          [2.4464975740051953, 48.79977274794218],
          [2.4481712724304883, 48.802232004782724],
          [2.448994250246783, 48.804572642388315],
          [2.449251742312213, 48.80773825694987],
          [2.4498928199060233, 48.81074418563539],
          [2.4492061743982108, 48.813683329736726],
          [2.4528110633142264, 48.816057128036],
          [2.4621666083581717, 48.820747875086916],
          [2.463883222127703, 48.82487310908313],
          [2.4660489491737625, 48.82568511873237],
          [2.4848879763489773, 48.82962885087687],
          [2.492913145721536, 48.83016562048326],
          [2.49355687588511, 48.829402840901245],
          [2.4934710451966335, 48.83050462990346],
          [2.493213553131204, 48.833527362491246],
          [2.4937285372620632, 48.83437482487633],
          [2.4945439288025906, 48.8357589826093],
          [2.4938493601729395, 48.838770968509266],
          [2.4934202067305566, 48.842809987705074],
          [2.4917623579072945, 48.848425846955905],
          [2.4893161832857125, 48.85624787755319],
          [2.4886667182784983, 48.85795843212525],
          [2.483602707658381, 48.86196767093066],
          [2.4829160621505686, 48.86371808293035],
          [2.482057755265803, 48.866428277501036],
          [2.482387888019617, 48.86812566292378],
          [2.4829028721504764, 48.86984763105044],
          [2.482318753412698, 48.8713807162711],
          [2.4801729862007837, 48.873356611704764],
          [2.4781559650215845, 48.87674367947028],
          [2.475143254965877, 48.88130475998278],
          [2.4717100274268144, 48.88356247187246],
          [2.4717529427710527, 48.88435264695573],
          [2.4730833184424394, 48.88562254504059],
          [2.4746078829486784, 48.88759530929477],
          [2.4740499834735807, 48.88926017224544],
          [2.472998261101309, 48.892774107849114],
          [2.469951271660391, 48.89726018112065],
          [2.469908356316153, 48.89821941498337],
          [2.4702945944142973, 48.900476363225714],
          [2.4698341352024578, 48.901330324187505],
          [2.467130468515446, 48.90347429399165],
          [2.464684293893864, 48.905307879409],
          [2.4621952039280437, 48.90640799836754],
          [2.453569219736149, 48.90795940702017],
          [2.447432325510075, 48.90984923975699]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/

var QA_BAND = 'cs_cdf';
var CLEAR_THRESHOLD = 0.60;

// Function to cloud masking and radiometric scaling
function cloud_score_plus_maskS2clouds_and_RadiometricScaling(image) {

  return image.updateMask(image.select(QA_BAND).gte(CLEAR_THRESHOLD)).multiply(0.0001);
}



function supervised_learning(roi,area_name){
  /* FUNCTION DESCRIPTION
    This function perform  perform  a random forest classification in a given region of interest of the of the 11  land cover classes.
    
    
    In particular this function use :
    -  Harmonized Sentinel-2 MSI: MultiSpectral Instrument, Level-2A image collection,
    -  ESA WorldCover 10m v200 -> provide an initial classification  of the 11  land cover classes (2021)
    -  Cloud Score+ S2_HARMONIZED V1 ->  is used to perform  cloud masking.
    
    to understand how the biomes in a region of interest are distributed. 
    
    
    This function give a region of interest will output:
    - its surface in squared km
    - the surface for each of the 11  land cover classes provided by ESA WorldCover 10m v200.
    Cloud Score+ S2_HARMONIZED V1

    Parameters:
    - roi (region of interest), must be a rectangle or polygon  area in which the analyis will be  performed.
    - area_name (OPTIONAL), used to have better print statement
    
  */
   
  
  
  
  
  // Since area_name is an optional parameter defined check if exist, if not initialize it with a generic value.
  if (area_name === undefined || area_name === null){
    area_name = "Roi";
  
  }

  
  /*-----------------------------------------------------*/
  // Get the data (get image collection and filter it)
  
  
/*
Dataset Availability (at 2024-06-08)
2017-03-28T00:00:00Z–2024-06-07T14:23:22Z
*/
// '2023-06-01', '2024-05-31' in order to take the last year (most recent collection possible)
  var S2_SR_coll_filtered = S2_SR_coll.filterDate('2023-06-07', '2024-06-07') // Filter by time period
                                 .filterBounds(roi)                          // Filter by zone
                                 .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE',50)); 
                                 // exclude all the images that have a cloud pixel percentage more than 50%
                                 // by selecting all the ones  with values lower than 50.
  
  

  

  
  // Apply cloud_score_plus_maskS2clouds_and_RadiometricScaling to the collection
  var S2_SR_coll_filtered_cloud_masked =  S2_SR_coll_filtered.linkCollection(csPlus, [QA_BAND])
                                                             .map(cloud_score_plus_maskS2clouds_and_RadiometricScaling);
  
  
  // Add the first image of  masked collection to the Map and cut if in the area of interest 
  Map.addLayer(S2_SR_coll_filtered_cloud_masked.first().clip(rome),
               {bands:['B4', 'B3', 'B2'], min:0, max:0.3},
               'S2_SR_coll_filtered first image RGB cloud score masking', false);
  
  
  // Take the median for a better image
  var median_SR_S2_image = S2_SR_coll_filtered_cloud_masked.median() // Median image
                                                           .select(["B1","B2","B3","B4",
                                                                    "B5","B6","B7","B8",
                                                                    "B8A","B9","B11","B12"]) // Select only some bands
                                                           .clip(roi); // Cut the image on rome
  
  
  // Add the median image to the map
  Map.addLayer(median_SR_S2_image, {bands:['B4', 'B3', 'B2'], min:0, max:0.3},
                                   'median_SR_S2_image RGB (cloud score masking)',true);
                                 
                                 
                                   
  /*-----------------------------------------------------*/
  // Get the dataset of 11 land covers from ESA
  
  
  var ESA_LC_image = ESA_world_LCs.first();
  var ESA_LC_image = ESA_LC_image.clip(roi);

  // Remap the values and the band
  var old_value_Classes = [10,20,30,40,50,60,70,80,90,95,100];
  var new_value_Classes = ee.List.sequence(0,10); 
  var ESA_LC_image = ESA_LC_image.remap(old_value_Classes,new_value_Classes).toByte().rename('LC');
  
  
  // Add ESA_LC_image to the Map
  //Map.addLayer(ESA_LC_image,{min:0,max:10},'ESA_LC_image 2021',false);
  
  
  
  
  // Define the color palette for each of the biomes of the imported training set
  var LC_palette = ['006400',  // 0   Tree cover
                    'ffbb22',  // 1   Shrubland
                    'ffff4c',  // 2   Grassland
                    'f096ff',  // 3   Cropland
                    'fa0000',  // 4   Built-up
                    'b4b4b4',  // 5   Bare / sparse vegetation
                    'f0f0f0',  // 6   Snow and ice
                    '0064c8',  // 7   Permanent water bodies
                    '0096a0',  // 8   Herbaceous wetland
                    '00cf75',  // 9   Mangroves
                    'fae6a0']; // 10  Moss and lichen
                    
  
  Map.addLayer(ESA_LC_image , {min:0,max:10, palette:LC_palette}, 'ESA_2021_LC 2021',false);
  
  

  /*-----------------------------------------------------*/
  // Define the training set
  
  // Define the datasetSample
  var datasetSample = median_SR_S2_image.addBands(ESA_LC_image)
                                        .stratifiedSample( // stratifiedSample is a particular way to sample
                                        
                                            // Dictionary of the parameters
                                            { // Spatial resolution at which we want to sample our dataset points(pixels)
                                              scale: 10, // m
                                              
                                              // Where to sample
                                              region: roi,
                                              
                                              // Enable the export of pixels coordinates
                                              geometries: true, // this by default is false, but we need to set it true because we need to know where the sampled pixels are in the map.
                                                                // By default is false because GEE by default is always looking for save some computations
                                              
                                              // To avoid memory errors
                                              tileScale : 4,
                                          
                                              // How many points per class we want to sample
                                              numPoints: 10000, // Number of points that must be taken for each class (at least try to have)
                                              
                                              // The name of the class band (our target)
                                              classBand: 'LC'
                                            }
                                          );
  
  // Add the dataset sample to the map
  Map.addLayer(datasetSample,{},"datasetSample",false); 
  
  // Get info about about the sample dataset
  var hist_datasetSample = datasetSample.reduceColumns(ee.Reducer.frequencyHistogram(),["LC"]);
  print("datasetSample reduceColumns,hist",hist_datasetSample);
  
  
  // Define train and validation set 
  datasetSample = datasetSample.randomColumn(); // Add a random column from a uniform in [0,1)
  var trainingSample  = datasetSample.filter(ee.Filter.lte("random",0.8));
  var validationSample  = datasetSample.filter(ee.Filter.gt("random",0.8));
  Map.addLayer(trainingSample,{},"trainingSample",false);
  Map.addLayer(validationSample,{},"trainingSample",false);
  
  // Get info about train and validation set 
  print("trainingSample histogram",trainingSample.reduceColumns(ee.Reducer.frequencyHistogram(),["LC"]));
  print("validationSample histogram",validationSample.reduceColumns(ee.Reducer.frequencyHistogram(),["LC"]));
  
  /*-----------------------------------------------------*/
  // Define the classifier
  var number_of_trees = 10;
  var RF_classifier = ee.Classifier.smileRandomForest(number_of_trees);
  
  
  // Train the classifier
  var trained_classifier = RF_classifier.train(
    { // Define the training dataset
      features: trainingSample,
      
      // Define the target variabile
      classProperty: 'LC', // is the LandCover (LC) band(column)
      
      // Features that we want to exploit in order to define the LC class for each pixels
      inputProperties: median_SR_S2_image.bandNames() 
      
      // median_SR_S2_image.bandNames() is a function  just to take the names without write them down
      // We take them from the median image, of course some bands must be removed since they are not useful
      // The band taken from median_SR_S2_image.bandNames() are to much,
      // we risks to waste memory and computation power, so let's select the bands that we need.
      // Just extract the surface reflectance bands (the ones that start which B)
      
      // go to line 55 where var median SR_S2 image is defined and select the bands
      // It is a good idea to select them at the beginning, so all the code will be faster and occupy less memory when runned
   
    }
    
    );
  
  
  
  
  
  // Get the accuracy
  var training_confusion_matrix = trained_classifier.confusionMatrix();
  print("training_accuracy",training_confusion_matrix.accuracy());
  
  var classified_validation = validationSample.classify(trained_classifier);
  var validation_confusion_matrix = classified_validation.errorMatrix('LC','classification');
  
  print('accuracy validation',validation_confusion_matrix.accuracy());
  
  
  var classified_median_SR_S2_image = median_SR_S2_image.classify(trained_classifier);
  Map.addLayer(classified_median_SR_S2_image,{min:0,max:10,palette:LC_palette},"classified_median_SR_S2_image 2023");
  print("classified_median_SR_S2_image",classified_median_SR_S2_image);
  
  // Get resolution 
  var S2_spatial_resolution = S2_SR_coll.first().select('B4').projection().nominalScale();
  print("S2_spatial_resolution",S2_spatial_resolution);
  
  
  // For loop to get the extension surface of each land cover
  var somma = 0;
  for (var index = 0; index < 11 ; index = index +1){
    var mask = classified_median_SR_S2_image.eq(index);
    var count = mask.reduceRegion({reducer: ee.Reducer.sum(),
                                   geometry: roi ,
                                   scale: S2_spatial_resolution,
                                   maxPixels: 1e9}).get('classification');
                                   
    var title = area_name + " biome " + index ;                                  
    var area_m2  = ee.Number(count).multiply(S2_spatial_resolution).multiply(S2_spatial_resolution);
    var area_km2 = area_m2.divide(1000).divide(1000); 
    
    var somma = ee.Number(somma).add(area_km2);
    var extension = title + " extension: ";
    
    Map.addLayer(mask,{},title,false);
    print(extension,area_km2);
  }
  
  
  print("Sum of the areas (" + area_name + "): ",somma);
  
  // Get the extension of the area of interest
  var total_pixel_count = median_SR_S2_image.reduceRegion({reducer: ee.Reducer.count(),geometry: roi, scale: S2_spatial_resolution, maxPixels: 1e9 });
  var pixel_count_result = total_pixel_count.get("B4");
  var extensions_of_roi_m2 = ee.Number(pixel_count_result).multiply(S2_spatial_resolution).multiply(S2_spatial_resolution);
  var extensions_of_roi_km2 = extensions_of_roi_m2.divide(1000).divide(1000);
  print("Extension of " + area_name ,extensions_of_roi_km2);
  
  // Get the extension of classified the area of interest
  var total_pixel_count = classified_median_SR_S2_image.reduceRegion({reducer: ee.Reducer.count(),geometry: roi, scale: S2_spatial_resolution, maxPixels: 1e9 });
  var pixel_count_result = total_pixel_count.get("classification");
  var extensions_of_roi_m2 = ee.Number(pixel_count_result).multiply(S2_spatial_resolution).multiply(S2_spatial_resolution);
  var extensions_of_roi_km2 = extensions_of_roi_m2.divide(1000).divide(1000);
  print("Extension of " + area_name + " (classified)" ,extensions_of_roi_km2);
    
    
  
}


// Run one at the time to avoid errors.
supervised_learning(rome,"Roma");
//supervised_learning(paris,"Parigi");
//supervised_learning(paris2,"Parigi2");
//supervised_learning(milan,"Milano");
//supervised_learning(milan2,"Milano");


